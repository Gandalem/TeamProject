<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>출.퇴근 관리</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/attendence.css">
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"/>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
</head>
<body>
   	<h3 class="h3">출.퇴근 관리</h3>
	<div class="at_odiv">
		<div class="at_div1">
			<form>
				<select class="form-select" id="company" name="company" onchange="ccompany();">
					<option>회사선택</option>
				</select>
				<select class="form-select" id="department" name="department" onchange="ddepartment();">
					<option>부서선택</option>
				</select>
				<select class="form-select" id="name" name="name" onchange="nname();">
					<option>이름선택</option>
				</select>
				<!-- 
				<div>
					<input type="date">
				</div>
				 -->
                <select class="form-select" id="year" name="year">
                    <option>년도</option>
                </select>
                <select class="form-select" id="month" name="month">
                    <option>월</option>
                </select>
				<button class="btn btn-secondary" id="bu1" type="button"> 조회하기 </button>				
			</form>
		</div>

        <div class="at_div2">
            <div class="at_div2_div1">
                <table class="table" id="attendanceTable">
                	<thead>
	                    <tr>
	                    	<th class="th1">요일</th>
	                        <th class="th2" colspan="4">출, 퇴근 시간</th>
	                        <th class="th3">비고란</th>
	                    </tr>
                    </thead>
                    <tbody>
	                    <tr>
	                    	<td class="td1"></td>
	                    	<td class="td2">출근</td>
	                        <td class="td3"></td>
	                        <td class="td2">퇴근</td>
	                        <td class="td3"></td>
	                        <!-- 비고란 -->
	                        <td class="td4">비고</td>
	                    </tr>
                    </tbody>
                </table>
            </div>

        </div>

	</div>
	
	
	<script>

	// 회사리스트
	$(document).ready(function(){
		$.ajax({
			url: "/clist/posts",
			method: "GET",
			dataType: "json",
			success : function(res){
				for(i=0;i<res.length;i++){
					$("#company").append('<option value="'+res[i].id+'">'+res[i].cname+'</option>');
				}
			}
			/*
			,
			error:function(request, status, error){
				console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
			}
			*/
		});
	});
	// 회사선택
	function ccompany(){
		var companyId = $("#company option:selected").val();
		$.ajax({
			url: "/clist/getDepartments",
			method:"GET",
			dataType:"json",
			data: {companyId : companyId},
			success : function(res){
				//부서 선택 dropdown 초기화
			    $("#department").empty();
			    $("#department").append('<option>부서선택</option>');
			    
				for(i=0;i<res.length;i++){
					$("#department").append('<option value="'+res[i].id+'">'+res[i].dname+'</option>');
				}
			}
		});
	}
	// 부서선택
	function ddepartment(){
		// 부서선택시
		var companyId = $("#company option:selected").val();
		var departmentId = $("#department option:selected").val();
		// ajax로 전송
		$.ajax({
			url: "/employee/userList",
			method:"GET",
			dataType:"json",
			data:{company: companyId,
				department : departmentId},
			success : function(res){
			    $("#name").empty();
			    $("#name").append('<option>이름선택</option>');
			    for(i=0;i<res.length;i++){
			        $("#name").append('<option value="'+res[i].idx+'">'+res[i].name+'</option>');
			        	// **res[i].idx를 res[i].id로 해서 undefined오류 발생함(시간 많이 잡아먹음)**
			    }
			}
		});
	}


	// 이름선택시
	function nname() {
	    var employeeIdx = $("#name option:selected").val();
	    console.log(employeeIdx);
	
	    $.ajax({
	        url: "/atten/years",
	        method: "GET",
	        dataType: "json",
	        data: { employeeIdx: employeeIdx}, // 변경된 변수 이름을 사용하여 data를 설정
	        
	        success: function(res) {
	            $("#year").empty();
	            $("#year").append('<option>년도</option>');

	            for (i=0;i<res.length;i++) {
	                $("#year").append('<option value="'+res[i]+'">'+res[i]+'</option>');
	            }
	        },
	    });

	    $("#year").change(function() {
	        var year = $("#year option:selected").val();
	        console.log(year);

	        $.ajax({
	            url: "/atten/months",
	            method: "GET",
	            dataType: "json",
	            data: {
	                employeeIdx: employeeIdx,
	                year: year,
	            },
	            success: function(res) {
	                $("#month").empty();
	                $("#month").append('<option>월</option>');

	                for (i=0;i<res.length;i++) {
	                    $("#month").append('<option value="'+res[i]+'">'+res[i]+'</option>');
	                }
	            },
	        });
	    });
	    
	    $("#month").change(function(){
	    	var month = $("#month option:selected").val();
	    	console.log(month);
	    });
	}   

	
	
	// 이 부분을 수정하여 DataTables를 초기화하고 데이터를 불러옵니다.
	$("#bu1").click(function(){
		var companyId = $("#company option:selected").val();
		var departmentId = $("#department option:selected").val();
		var employeeIdx = $("#name option:selected").val();
		var year = $("#year option:selected").val();
		var month = $("#month option:selected").val();
		
		
		
		
	});
	
	var table = $('#attendanceTable').DataTable({
		searching: false,
		paging: false,
		ordering: true,
		info: false,
		serverSide: true,
		processing: true,
		destroy: true,
		ajax: {
			url: '/atten/search',
		    type: 'GET',
		    dataSrc: '',
		},
		columns: [
			{ data: 'today' }
	 	]	  	
	});

</script>
</body>

</html>
